# Базовый процесс создания и публикации плагина

## Принцип
1. На примере плагина для работы с кросс-доменными запросами, плагин состоит из трех частей: программа для посредника обработки кросс-доменных запросов, файл конфигурации посредника middleware.php и Install.php, который создается автоматически с помощью команды.
2. Мы используем команду для упаковки и публикации этих трех файлов в композере.
3. При установке плагина для работы с кросс-доменными запросами с помощью композера, Install.php копирует файл программы посредника обработки кросс-доменных запросов и файл конфигурации в папку `{основной_проект}/config/plugin`, чтобы webman мог загрузить их. Это позволяет автоматически применить конфигурацию программы посредника обработки кросс-доменных запросов.
4. При удалении плагина с помощью композера, Install.php удаляет соответствующие файлы программы посредника обработки кросс-доменных запросов и файл конфигурации, обеспечивая автоматическое удаление плагина.

## Стандарты
1. Название плагина состоит из двух частей - `производитель` и `название_плагина`, например `webman/push`, оно соответствует имени пакета композера.
2. Файл конфигурации плагина обычно находится в папке `config/plugin/производитель/название_плагина/` (команда консоли автоматически создаст эту папку). Если плагин не требует конфигурации, необходимо удалить автоматически созданную папку с конфигурацией.
3. Папка конфигурации плагина поддерживает только следующие файлы: app.php (основная конфигурация плагина), bootstrap.php (конфигурация запуска процесса), route.php (конфигурация маршрутов), middleware.php (конфигурация посредников), process.php (пользовательская конфигурация процессов), database.php (конфигурация базы данных), redis.php (конфигурация Redis), thinkorm.php (конфигурация ThinkORM). Эти конфигурационные файлы будут автоматически распознаны webman.
4. Плагин использует следующий метод для доступа к конфигурации: `config('plugin.производитель.название_плагина.имя_файла_конфигурации.конкретный_настройка');`, например `config('plugin.webman.push.app.app_key')`.
5. Если у плагина есть собственная конфигурация базы данных, то к ней можно получить доступ следующим образом: `illuminate/database` как `Db::connection('plugin.производитель.название_плагина.конкретное_подключение')`, `thinkorm` как `Db::connection('plugin.производитель.название_плагина.конкретное_подключение')`.
6. Если плагин должен размещаться в папке `app/` в проекте, необходимо убедиться, что он не конфликтует с файлами других плагинов или проекта пользователя.
7. Плагин должен по возможности избегать копирования файлов или каталогов в основной проект, например, для плагина для работы с кросс-доменными запросами, кроме файлов конфигурации, посредников следует поместить в папку `vendor/webman/cros/src`, а не копировать в основной проект.
8. Рекомендуется использовать заглавные буквы для пространств имен плагинов, например Webman/Console.

## Пример

**Установка командной строки `webman/console`**

`composer require webman/console`

#### Создание плагина

Предположим, что создается плагин с названием `foo/admin` (имя также является именем проекта, который будет опубликован позже с помощью композера, имя должно быть в нижнем регистре).
Выполните команду:
`php webman plugin:create --name=foo/admin`

После создания плагина будет создана папка `vendor/foo/admin` для хранения связанных файлов плагина, а также папка `config/plugin/foo/admin` для хранения конфигурации плагина.

> Заметка
> Папка `config/plugin/foo/admin` поддерживает следующую конфигурацию: app.php (основная конфигурация плагина), bootstrap.php (конфигурация запуска процесса), route.php (конфигурация маршрутов), middleware.php (конфигурация посредников), process.php (пользовательская конфигурация процессов), database.php (конфигурация базы данных), redis.php (конфигурация Redis), thinkorm.php (конфигурация ThinkORM). Формат конфигурации аналогичен webman, и эти конфигурации будут автоматически распознаны и объединены webman.
Для доступа к ним используется префикс `plugin`, например config('plugin.foo.admin.app');

#### Экспорт плагина

После завершения разработки плагина выполните следующую команду для экспорта плагина:
`php webman plugin:export --name=foo/admin`

> Примечание
> После экспорта папка config/plugin/foo/admin будет скопирована в папку src вендора foo/admin, а также будет создан файл Install.php для автоматической установки и удаления плагина.
Операции по установке по умолчанию включают копирование конфигурации из папки vendor/foo/admin/src в текущий проект config/plugin, а операции по удалению по умолчанию включают удаление файлов конфигурации из текущего проекта config/plugin.
Вы можете изменить Install.php для выполнения дополнительных пользовательских операций при установке и удалении плагина.

#### Публикация плагина
* Предположим, у вас уже есть учетные записи [github](https://github.com) и [packagist](https://packagist.org)
* На [github](https://github.com) создайте проект admin и загрузите туда код. Предположим, адрес проекта такой: `https://github.com/your_username/admin`
* Перейдите по адресу `https://github.com/your_username/admin/releases/new` и опубликуйте релиз, например `v1.0.0`
* На сайте [packagist](https://packagist.org) нажмите "Submit" и отправьте адрес своего проекта на github, `https://github.com/your_username/admin`. Таким образом плагин будет опубликован.

> **Подсказка**
> Если при отправке плагина на `packagist` возникают конфликты, можно попробовать изменить имя производителя, например `foo/admin` измените на `myfoo/admin`

Далее, когда у вас будет обновление кода плагина, необходимо синхронизировать код на github, затем снова перейти по адресу `https://github.com/your_username/admin/releases/new` и заново опубликовать релиз, а затем на странице `https://packagist.org/packages/foo/admin` нажать кнопку `Update` для обновления версии.

## Добавление команды в плагин
Иногда плагину необходимы некоторые пользовательские команды для предоставления вспомогательных функций, например при установке плагина `webman/redis-queue`, проект автоматически будет обогащен командой `redis-queue:consumer`, чтобы пользователь мог запустить `php webman redis-queue:consumer send-mail` и создастся класс потребителя SendMail.php, что ускорит разработку.

Предположим, что плагин `foo/admin` нуждается в добавлении команды `foo-admin:add`, следуйте следующим шагам.

#### Создание команды

**Создайте файл команды `vendor/foo/admin/src/FooAdminAddCommand.php`**

```php
<?php

namespace Foo\Admin;

use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Input\InputArgument;

class FooAdminAddCommand extends Command
{
    protected static $defaultName = 'foo-admin:add';
    protected static $defaultDescription = 'Описание команды';

    /**
     * @return void
     */
    protected function configure()
    {
        $this->addArgument('name', InputArgument::REQUIRED, 'Add name');
    }

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     * @return int
     */
    protected function execute(InputInterface $input, OutputInterface $output)
    {
        $name = $input->getArgument('name');
        $output->writeln("Admin add $name");
        return self::SUCCESS;
    }

}
```

> **Важно**
> Чтобы избежать конфликтов между командами плагинов, формат командной строки рекомендуется `производитель-название_плагина:конкретная_команда`, например все команды плагина `foo/admin` должны иметь префикс `foo-admin:`, например `foo-admin:add`.

#### Добавление конфигурации
**Создайте конфигурацию `config/plugin/foo/admin/command.php`**
```php
<?php

use Foo\Admin\FooAdminAddCommand;

return [
    FooAdminAddCommand::class,
    // ....можно добавить множество конфигураций...
];
```

> **Подсказка**
> `command.php` используется для настройки пользовательских команд плагина. Каждый элемент массива соответствует классу командной строки, а каждый класс соответствует команде. При выполнении пользовательской команды `webman/console` автоматически загружает каждый плагин `command.php`, настраивая пользовательские команды. Для получения дополнительной информации о командной строке обратитесь к [командной строке](console.md)

#### Экспорт
Выполните команду `php webman plugin:export --name=foo/admin` для экспорта плагина и его публикации на `packagist`. Таким образом, при установке плагина `foo/admin` пользователю будет доступна команда `foo-admin:add`. Выполнение `php webman foo-admin:add jerry` выведет `Admin add jerry`.
