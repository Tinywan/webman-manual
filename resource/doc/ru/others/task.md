# Обработка медленных бизнес-процессов

Иногда нам нужно обрабатывать медленные бизнес-процессы, чтобы избежать влияния этих процессов на обработку других запросов webman. В зависимости от ситуации эти бизнес-процессы могут использовать различные методы обработки.

## Использование очередей сообщений
Смотрите [redis очередь](https://www.workerman.net/plugin/12) [stomp очередь](https://www.workerman.net/plugin/13)

### Преимущества
Может обрабатывать внезапные большие запросы на обработку бизнес-процессов

### Недостатки
Невозможно напрямую вернуть результат клиенту. Если необходимо отправить результат, необходимо использовать другой сервис, например, [webman/push](https://www.workerman.net/plugin/2) для отправки результата обработки.

## Добавление HTTP-порта

> **Заметка**
> Эта функция требует webman-framework >= 1.4

Добавление HTTP-порта для обработки медленных запросов, которые обрабатываются определенным набором процессов через доступ к этому порту, и после обработки результат непосредственно возвращается клиенту.

### Преимущества
Можно непосредственно возвращать данные клиенту

### Недостатки
Невозможно обрабатывать внезапные большие запросы

### Шаги реализации
Добавьте следующую конфигурацию в файл `config/process.php`.
```php
return [
    // ... здесь опущены другие конфигурации ...
    
    'task' => [
        'handler' => \Webman\App::class,
        'listen' => 'http://0.0.0.0:8686',
        'count' => 8, // количество процессов
        'user' => '',
        'group' => '',
        'reusePort' => true,
        'constructor' => [
            'request_class' => \support\Request::class, // установка класса запроса
            'logger' => \support\Log::channel('default'), // экземпляр журнала событий
            'app_path' => app_path(), // расположение каталога приложения
            'public_path' => public_path() // расположение каталога public
        ]
    ]
];
```

Таким образом, медленные запросы могут проходить через этот группу процессов через `http://127.0.0.1:8686/`, не влияя на обработку других процессов.

Чтобы клиенты не замечали разницы в портах, можно добавить прокси для порта 8686 в nginx. Предположим, что все медленные запросы начинаются с `/tast`. Пример конфигурации nginx выглядит следующим образом:
```
upstream webman {
    server 127.0.0.1:8787;
    keepalive 10240;
}

# Добавление нового upstream для 8686 порта
upstream task {
   server 127.0.0.1:8686;
   keepalive 10240;
}

server {
  server_name webman.com;
  listen 80;
  access_log off;
  root /path/webman/public;

  # Запросы, начинающиеся с /tast, направляются на порт 8686. Пожалуйста, замените /tast на необходимый вам префикс
  location /tast {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Host $host;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      proxy_pass http://task;
  }

  # Другие запросы направляются на исходный порт 8787
  location / {
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header Host $host;
      proxy_http_version 1.1;
      proxy_set_header Connection "";
      if (!-f $request_filename){
          proxy_pass http://webman;
      }
  }
}
```

Таким образом, при доступе клиентов к `домен.com/tast/xxx` запросы будут направляться на отдельный порт 8686 для обработки, не влияя на обработку запросов на порту 8787.
