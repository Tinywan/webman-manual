# Бизнес-инициализация

Иногда нам нужно выполнить некоторые бизнес-инициализации после запуска процесса, которые должны выполняться только один раз за жизненный цикл процесса, например, установка таймера после запуска процесса или инициализация подключения к базе данных и т. д. Ниже мы рассмотрим это подробнее.

## Принцип

Согласно **[процессу выполнения](process.md)**, после запуска процесса webman загружает классы, установленные в `config/bootstrap.php` (включая `config/plugin/*/*/bootstrap.php`) и выполняет метод start класса. Мы можем добавить свой бизнес-код в метод start для выполнения инициализации после запуска процесса.

## Процесс

Допустим, нам нужно создать таймер для периодической отчетности о текущем использовании памяти процессом. Назовем этот класс `MemReport`.

#### Выполнение команды

Введите команду `php webman make:bootstrap MemReport` для создания файла инициализации `app/bootstrap/MemReport.php`.

> **Подсказка**
> Если у вас нет установленного `webman/console`, выполните команду `composer require webman/console` для установки.

#### Редактирование файла инициализации
Отредактируйте файл `app/bootstrap/MemReport.php` следующим образом:
```php
<?php

namespace app\bootstrap;

use Webman\Bootstrap;

class MemReport implements Bootstrap
{
    public static function start($worker)
    {
        // Является ли это командной строкой?
        $is_console = !$worker;
        if ($is_console) {
            // Если вы не хотите, чтобы этот инициализатор запускался в командной строке, просто верните его здесь
            return;
        }
        
        // Выполнять каждые 10 секунд
        \Workerman\Timer::add(10, function () {
            // Для удобства демонстрации здесь использован вывод вместо процесса отчетности
            echo memory_get_usage() . "\n";
        });
        
    }

}
```

> **Подсказка**
> При использовании командной строки фреймворк также выполняет метод start, указанный в `config/bootstrap.php`. Мы можем использовать проверку `$worker` на null, чтобы определить, находится ли процесс в командной строке, и соответственно решить, следует ли выполнять бизнес-код инициализации.

#### Настройка для запуска с процессом
Откройте `config/bootstrap.php` и добавьте класс `MemReport` в список для запуска.
```php
return [
    // ...здесь пропущены другие настройки...
    
    app\bootstrap\MemReport::class,
];
```

Таким образом, мы завершили процесс бизнес-инициализации.

## Дополнительные пояснения

[Пользовательский процесс](../process.md) также выполняет метод start, указанный в `config/bootstrap.php`. Мы можем использовать `$worker->name` для определения текущего процесса и решить, должен ли выполняться в этом процессе ваш бизнес-код инициализации, например, если нам не нужно отслеживать процесс monitor, то содержимое `MemReport.php` будет выглядеть примерно так:
```php
<?php

namespace app\bootstrap;

use Webman\Bootstrap;

class MemReport implements Bootstrap
{
    public static function start($worker)
    {
        // Является ли это командной строкой?
        $is_console = !$worker;
        if ($is_console) {
            // Если вы не хотите, чтобы этот инициализатор запускался в командной строке, просто верните его здесь
            return;
        }
        
        // Процесс monitor не выполняет таймер
        if ($worker->name == 'monitor') {
            return;
        }
        
        // Выполнять каждые 10 секунд
        \Workerman\Timer::add(10, function () {
            // Для удобства демонстрации здесь использован вывод вместо процесса отчетности
            echo memory_get_usage() . "\n";
        });
        
    }

}
```
