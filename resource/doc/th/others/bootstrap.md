# การเริ่มต้นธุรกิจ

บางครั้งเราต้องการทำการเริ่มต้นธุรกิจหลังจากที่กระบวนการเริ่มต้น การเริ่มต้นนี้จะทำงานเพียงครั้งเดียวตลอดชีพกระบวนการ เช่น เมื่อเริ่มต้นกระบวนการสามารถตั้งชัวโมงการเริ่มต้นหรือเริ่มต้นการเชื่อมต่อฐานข้อมูล เป็นต้น ด้านล่างนี้เราจะอธิบายเกี่ยวกับเรื่อนี้

## หลักการ
อ้างอิงจากคำอธิบายใน **[ขั้นตอนการดำเนินงาน](process.md)** webman จะโหลดคลาสที่ได้ตั้งค่าไว้ใน `config/bootstrap.php` (รวมถึง `config/plugin/*/*/bootstrap.php`) และเริ่มต้นการทำงานของคลาสด้วยการใช้เมธอด start ในคลาสนั้น พวกเราสามารถนำรหัสธุรกิจที่ต้องการใช้งานหลังการเริ่มต้นกระบวนการมาวางใน start method ได้

## ขั้นตอนการดำเนินงาน
สมมติว่าเราต้องการสร้างตัวจัดเวลาที่ใช้สำหรับการรายงานการใช้งานหน่วยความจำในกระบวนการ คลาสนี้เราจะตั้งชื่อว่า `MemReport`

#### ดำเนินการคำสั่ง

ดำเนินการคำสั่ง `php webman make:bootstrap MemReport` เพื่อสร้างไฟล์เริ่มต้น `app/bootstrap/MemReport.php`

> **เรียนรู้เพิ่มเติม**
> หาก webman ของคุณยังไม่ได้ติดตั้ง `webman/console` กรุณาดำเนินการคำสั่ง `composer require webman/console` เพื่อทำการติดตั้ง

#### แก้ไขไฟล์เริ่มต้น
แก้ไขไฟล์ `app/bootstrap/MemReport.php` โดยมีเนื้อหาเป็นดังนี้:
```php
<?php

namespace app\bootstrap;

use Webman\Bootstrap;

class MemReport implements Bootstrap
{
    public static function start($worker)
    {
        // เป็นสภาพแวดล้อมของโทรมหรือไม่ ?
        $is_console = !$worker;
        if ($is_console) {
            // หากคุณไม่ต้องการที่โทรมจะทำการเริ่มต้นนี้ คุณสามารถทำการเริ่มต้น จากที่นี้เลย
            return;
        }
        
        // ขอให้มันทำงานทุกๆ 10 วินาที
        \Workerman\Timer::add(10, function () {
            // เพื่อสะดวกในการสาธิต เราใช้การแสดงผลแทนการรายงาน
            echo memory_get_usage() . "\n";
        });
        
    }

}
```

> **เรียนรู้เพิ่มเติม**
> ในขณะที่ที่ใช้โทรม ตลอดทั้งไป กรอบการทำงานจะทำการเริ่มต้นเมธอด start ที่ได้ตั้งค่าไว้ที่ `config/bootstrap.php` เราสามารถทำการสอบดูว่า `$worker` นั้นเป็น null หรือไม่เพื่อตรวจสอบว่าเป็นสภาพแวดล้อมของโทรมหรือไม่ หากเป็นเราสามารถตัดสินใจว่าจะทำการทำงานจากทางด้านธุรกิจการเริ่มต้นหรือเปล่า

#### เพิ่มการกำหนดเพื่อเริ่มทำงานพร้อมกับกระบวนการ
เปิด `config/bootstrap.php` เพื่อเพิ่มคลาส `MemReport` ลงไปในรายการเริ่มต้น
```php
return [
    // ... ข้างล่างนี้มีการตั้งค่าอื่นๆ ที่ถูกตัดออก ...
    
    app\bootstrap\MemReport::class,
];
```

ในที่นี้เราจึงก่อตาการเริ่มต้นธุรกิจ

## ข้อความเพิ่มเติม
เมื่อเริ่มต้น[กระบวนการที่กำหนดเอง](../process.md) ยังจะทำการเริ่มเมธอด start ที่ได้ตั้งค่าไว้ที่ `config/bootstrap.php` เราสามารถใช้ ` $worker->name` เพื่อตรวจสอบว่าจะทำการทำงานในกระบวนการใด และเป็นสาเหตุเพื่อตัดสินใจว่าคุณจะทำการเริ่มต้นธุรกิจในกระบวนการนั้นหรือไม่ เช่น เราไม่จำเป็นต้องมีการตรวจสอบการจดอนกระบวนการ monitor จะมีเนื้อหาของ `MemReport.php` ดังนี้:
```php
<?php

namespace app\bootstrap;

use Webman\Bootstrap;

class MemReport implements Bootstrap
{
    public static function start($worker)
    {
        // เป็นสภาพแวดล้อมของโทรมหรือไม่ ?
        $is_console = !$worker;
        if ($is_console) {
            // หากคุณไม่ต้องการที่โทรมจะทำการเริ่มต้นนี้ คุณสามารถทำการเริ่มต้น จากที่นี้เลย
            return;
        }
        
        // ไม่ต้องทำการติดตาม monitor ทำงานอัตโนมัติ
        if ($worker->name == 'monitor') {
            return;
        }
        
        // ขอให้มันทำงานทุกๆ 10 วินาที
        \Workerman\Timer::add(10, function () {
            // เพื่อสะดวกในการสาธิต เราใช้การแสดงผลแทนการรายงาน
            echo memory_get_usage() . "\n";
        });
        
    }

}
```
