# เกี่ยวกับการรั่วหน่วยความจำ

webman เป็นโครงสร้างที่ถูกเก็บที่หน่วยความจำและเราจึงต้องให้ความสนใจในเรื่องการรั่วหน่วยความจำ แต่นักพัฒนาไม่จำเป็นต้องกังวลมาก เพราะการรั่วหน่วยความจำเกิดขึ้นในเงื่อนไขที่極端มาก และง่ายต่อการหลีกเลี่ยง webman เป็นการพัฒนาเชิงเดียวกับโครงสร้างที่เป็นที่นิยม ไม่จำเป็นต้องทำการจัดการหน่วยความจำเกินไป

> **เคล็ดลับ**
> กระบวนการตรวจสอบของ webman จะตรวจสอบโปรเซสที่ใช้หน่วยความจำ ถ้าหากโปรเซสที่ใช้หน่วยความจำใกล้ถึงค่าที่กำหนดไว้ใน `memory_limit` ของ php.ini จะทำการรีสตาร์ทโปรเซสนั้นๆโดยตอนนั้นที่ไม่มีผลกระทบต่อธุรกิจ

## คำจำกัดความของการรั่วหน่วยความจำ
เมื่อคำร้องขอเพิ่มขึ้น หน่วยความจำที่ webman ใช้ก็จะเพิ่มขึ้น **อย่างไมมีขอบเขต** (กรุณาสังเกตว่าเป็นการเพิ่มขึ้น **อย่างไมมีขอบเขต**) สูงสุดไปจนถึงหลายร้อยเมกะไบต์หรือมากกว่านั้น เราจึงเรียกว่านี้คือการรั่วหน่วยความจำ แต่หากหน่วยความจำเพิ่มขึ้นแล้วหยุดเพิ่มขึ้นไม่หมายถึงว่ามีการรั่วหน่วยความจำ

โซนของหน่วยความจำที่ webman ใช้ชอบ:
1. อาร์เรย์ที่ใช้คำว่า static
2. อาร์เรย์ซิงเกิลที่มีคุณลักษณะ
3. อาร์เรย์ที่ใช้คำว่า global

> **โปรดทราบ**
> webman ช่วยให้คุณสามารถใช้ข้อมูลที่มีอายุการใช้งานยาวนาน แต่คุณต้องรักษาให้แน่ใจว่าข้อมูลในอาร์เรย์มีค่าจำกัดและจำนวนของพาสเล่นต์จะไม่เพิ่มขึ้นอย่างไมมีขอบเขต

ตัวอย่างต่อไปนี้ชำระแสดงถึงแต่ละข้อ

#### อาร์เรย์ static ที่มีการขยายอย่างไมมีขอบเขต
```php
class Foo
{
    public static $data = [];
    public function index(Request $request)
    {
        self::$data[] = time();
        return response('hello');
    }
}
```

การกำหนดอาร์เรย์ที่มีคำว่า static อย่าง `$data` ไว้เป็นอาร์เรย์ที่ใช้งานอย่างยาวนาน และในตัวอย่างนี้ อาร์เรย์ `$data` เพิ่มขึ้นตามคำร้องโดยทำให้การใช้งานหน่วยความจำเพิ่มขึ้น ซึ่งนำไปสู่การรั่วหน่วยความจำ

#### อาร์เรย์ซิงเกิลที่มีการขยายอย่างไมมีขอบเขต
```php
class Cache
{
    protected static $instance;
    public $data = [];
    
    public function instance()
    {
        if (!self::$instance) {
            self::$instance = new self;
        }
        return self::$instance;
    }
    
    public function set($key, $value)
    {
        $this->data[$key] = $value;
    }
}
```

โค้ดการเรียกใช้งาน
```php
class Foo
{
    public function index(Request $request)
    {
        Cache::instance()->set(time(), time());
        return response('hello');
    }
}
```

`Cache::instance()` คืนค่า singleton ของ Cache ซึ่งเป็นอาร์เรย์ที่มีอายุการใช้งานยาวนาน แม้ว่าแท้จริง `$data` มีไม่มีคำว่า static แต่เนื่องจากคลาสมีอายุการใช้งานยาวนาน ดังนั้น `$data` ก็เป็นอาร์เรย์ที่มีอายุการใช้งานยาวนานด้วย หากมีการเพิ่มข้อมูล key ต่างๆลงในอาร์เรย์ `$data` โปรแกรมก็จะใช้หน่วยความจำมากขึ้นเรื่อยๆ ซึ่งจะทำให้การรั่วหน่วยความจำเกิดขึ้น

> **โปรดทราบ**
> หากการเพิ่ม key ต่างๆลงใน `$data` นั่นมีจำนวนที่จำกัด การรั่วหน่วยความจำก็จะไม่เกิดเพราะอาร์เรย์ `$data` ไม่ได้ขยายอย่างไม่จำกัด

#### อาร์เรย์ global ที่มีการขยายอย่างไมมีขอบเขต
```php
class Index
{
    public function index(Request $request)
    {
        global $data;
        $data[] = time();
        return response($foo->sayHello());
    }
}
```
การกำหนดอาร์เรย์ด้วยคำว่า global ไม่ได้ทำให้อาร์เรย์นี้ถูกทำลายหลังจากการเรียกใช้คำสั่งหรือเมธอดแล้ว ดังนั้นอาร์เรย์นี้ก็เป็นอาร์เรย์ที่มีอายุการใช้งานยาวนานและโค้ดด้านบนเมื่อการร้องขอเพิ่มขึ้น ก็ทำให้เกิดการรั่วหน่วยความจำ เช่นเดียวกัน หากใช้คำว่า static ในฟังก์ชันหรือคำสั่งบรรทัดนอกแล้วก็จะเป็นอาร์เรย์ที่มีอายุการใช้งานยาวนาน หากมีการขยายเอะไรไปได้ จะเกิดรั่วหน่วยความจำเช่นเดียวกัน เช่น:
```php
class Index
{
    public function index(Request $request)
    {
        static $data = [];
        $data[] = time();
        return response($foo->sayHello());
    }
}
```

## คำแนะนำ
เราขอแนะนำให้นักพัฒนาไม่จำเป็นต้องให้ความสนใจในการรั่วความจำมากเกินไป เพราะมันไม่ตายจริงๆ แม้กระทั่งผู้ใช้จะไม่ค้นพบจุดที่ข้อมูลรั่วหน่วยความจำ กระบวนการตรวจสอบของ webman ก็จะทำให้การรีสตาร์ทโปรเซสที่เกิดการรั่วหน่วยความจำเป็นในเวลาที่เหมาะสม เพื่อทำให้เกิดการทำลายหน่วยความจำ

หากต้องการที่จะหลีกเลี่ยงการรั่วหน่วยความจำในการใช้งาน ขอแนะนำให้ใช้คำสั่งต่อไปนี้:
1. หลีกเลี่ยงให้คำสั่งมีคำว่า global, static ในอาร์เรย์และความแน่ใจว่าจะไม่มีการขยายอย่างไม่มีขอบเขต
2. หากมีคลาสที่ไม่รู้จักให้ไม่ใช้ sigleton ใช้ new ในการกำหนด หากท่าไม่จำเป็นต้องใช้ sigleton อย่างนี้ให้ตรวจสอบว่ามันมีอาร์เรย์ที่ขยายอย่างไม่มีขอบเขตหรือไม่
