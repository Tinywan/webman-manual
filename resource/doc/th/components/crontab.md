# คอมโพเนนต์งานที่ตั้งเวลาล่วงหน้า

## workerman/crontab

### คำอธิบาย

`workerman/crontab` คล้ายกับ crontab ของ Linux โดยต่างกันที่ `workerman/crontab` รองรับการตั้งเวลาทุกวินาที

คำอธิบายเกี่ยวกับเวลา:

```
0   1   2   3   4   5
|   |   |   |   |   |
|   |   |   |   |   +------ วันในสัปดาห์ (0 - 6) (Sunday=0)
|   |   |   |   +------ เดือน (1 - 12)
|   |   |   +-------- วันในเดือน (1 - 31)
|   |   +---------- ชั่วโมง (0 - 23)
|   +------------ นาที (0 - 59)
+-------------- วินาที (0-59)[สามารถข้าม, ถ้าไม่มี 0 แล้วจะเป็นเวลาของนาทีเล็กสุด]
```

### ที่อยู่ของโปรเจกต์

https://github.com/walkor/crontab

### การติดตั้ง

```php
composer require workerman/crontab
```

### การใช้

**ขั้นตอนที่หนึ่ง: สร้างไฟล์เสริม `process/Task.php`**

```php
<?php
namespace process;

use Workerman\Crontab\Crontab;

class Task
{
    public function onWorkerStart()
    {
        // ทำงานทุกวินาที
        new Crontab('*/1 * * * * *', function(){
            echo date('Y-m-d H:i:s')."\n";
        });
        
        // ทำงานทุก 5 วินาที
        new Crontab('*/5 * * * * *', function(){
            echo date('Y-m-d H:i:s')."\n";
        });
        
        // ทำงานทุกนาที
        new Crontab('0 */1 * * * *', function(){
            echo date('Y-m-d H:i:s')."\n";
        });
        
        // ทำงานทุก 5 นาที
        new Crontab('0 */5 * * * *', function(){
            echo date('Y-m-d H:i:s')."\n";
        });
        
        // ทำงานทุกนาทีที่ 1
        new Crontab('1 * * * * *', function(){
            echo date('Y-m-d H:i:s')."\n";
        });
      
        // ทำงานทุกวัน เวลา 7 โมง 50 นาที โปรดทราบว่า ข้าม วินาทีที่ 1
        new Crontab('50 7 * * *', function(){
            echo date('Y-m-d H:i:s')."\n";
        });
    }
}
```

**ขั้นตอนที่สอง: ตั้งค่าให้ไฟล์เสริมทำงานพร้อมกับ webman**

เปิดไฟล์การตั้งค่า `config/process.php` เพิ่มการตั้งค่าดังต่อไปนี้

```php
return [
    ....การตั้งค่าอื่น ๆ, ถูกต้องตามลำดับ....
  
    'task'  => [
        'handler'  => process\Task::class
    ],
];
```

**ขั้นตอนที่สาม: รีสตาร์ท webman**

> ข้อควรระวัง: งานตามเวลาที่ตั้งไว้จะไม่ทำงานทันที งานตามเวลาจะได้เริ่มทำงานที่นาทีถัดไป

### คำอธิบาย
crontab ไม่ใช่เหตุการณ์แบบเบะๆ ตัวอย่างเช่น กระบวนการทำงานอยู่ในตัวของ task ได้ตั้งค่าไว้ A และ B สอง Cronjob, ทั้งคู่ถูกตั้งค่าให้ทำงานทุกวินาที แต่งาน A ใช้เวลา 10 วินาที เมื่องาน A ยังไม่จบ B จึงต้องรอจนกว่างาน A จะเสร็จ ส่งผลให้งาน B จะทำงานช้าลง
ถ้าธุรกิจต้องการตั้งเวลาที่มีความเร่งด่วน, ควรนำงานตามเวลาที่ก่อให้เกิดความผันผวนไปทำงานในกระบวนการที่แยกออกไป ดังตัวอย่าง `config/process.php` อาจตั้งค่าดังนี้

```php
return [
    ....การตั้งค่าอื่น ๆ, ถูกต้องตามลำดับ....
  
    'task1'  => [
        'handler'  => process\Task1::class
    ],
    'task2'  => [
        'handler'  => process\Task2::class
    ],
];
```
โอนงานที่ต่อเวลาไปใน `process/Task1.php` และ งานที่เหลือไปที่ `process/Task2.php`
