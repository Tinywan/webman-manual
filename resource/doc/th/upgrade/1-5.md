# 1.5 คู่มือการอัพเกรด

**ก่อนอัพเกรด โปรดสำรองข้อมูล และดำเนินการดังนี้เพื่ออัพเกรด**
`composer require workerman/webman-framework ^1.5 -W && composer require webman/console ^1.2.12 && php webman install`

# คุณสมบัติและการเปลี่ยนแปลง

รองรับ workerman v5 [coroutine](https://www.workerman.net/doc/workerman/fiber.html)

> **คำแนะนำ**
> workerman v5 ต้องการ PHP>=8.1
> คำสั่งอัพเกรด workerman `composer require workerman/workerman ^5.0.0 -W`
> Coroutine ต้องการติดตั้ง `composer require revolt/event-loop ^1.0.0`

# ตัวอย่าง
### การตอบสนองช้า

```php
<?php

namespace app\controller;

use support\Request;
use Workerman\Timer;

class TestController
{
    public function index(Request $request)
    {
        // หลับ 1.5 วินาที
        Timer::sleep(1.5);
        return $request->getRemoteIp();
    }
}
```
`Timer::sleep()` คล้ายกับฟังก์ชัน `sleep()` ของ PHP แตกต่างกันที่ `Timer::sleep()` ไม่ Block เธรด

### การส่งคำขอ HTTP

> **โปรดทราบ**
> ต้องติดตั้ง composer require workerman/http-client ^2.0.0

```php
<?php

namespace app\controller;

use support\Request;
use Workerman\Http\Client;

class TestController
{
    public function index(Request $request)
    {
        static $client;
        $client = $client ?: new Client();
        $response = $client->get('http://example.com'); // ส่งคำขอไม่ block แบบ synchronous
        return $response->getBody()->getContents();
    }
}
```
การส่งคำขอ `$client->get()` ก็ไม่ Block และสามารถนำไปใช้ในการประมวลผลคำขอ HTTP โดยไม่ Block เพื่อเพิ่มประสิทธิภาพ

อ่านเพิ่มเติมที่ [workerman/http-client](https://www.workerman.net/doc/workerman/components/workerman-http-client.html)

### เพิ่ม support\Context คลาส

support\Context คลาสใช้เก็บข้อมูลที่เกี่ยวข้องกับคำขอ และเมื่อคำขอเสร็จสมบูรณ์ข้อมูล context ที่เกี่ยวข้องก็จะถูกลบโดยอัตโนมัติ กล่าวคือ ข้อมูล context มีรองรับที่ยังอยู่ตามรอยของคำขอ

### ประสิทธิภาพของตัวแปรทั่วไป
สภาพแวดล้อมของ Coroutine จะไม่อนุญาตให้เก็บสถานะของข้อมูลที่เกี่ยวข้องกับคำขอไว้ในตัวแปรทั่วไปหรือตัวแปรแบบแถวตรงเพราะอาจทำให้เกิดข้อผิดพลาดของข้อมูลระดับโลก เช่น

```php
<?php

namespace app\controller;

use support\Request;
use Workerman\Timer;

class TestController
{
    protected static $name = '';

    public function index(Request $request)
    {
        static::$name = $request->get('name');
        Timer::sleep(5);
        return static::$name;
    }
}
```

เมื่อกำหนดจำนวนเธรดเป็น 1 หากเราส่งคำขอสองคำขอติดต่อกันที่  
http://127.0.0.1:8787/test?name=lilei  
http://127.0.0.1:8787/test?name=hanmeimei  
เราคาดหวังว่าผลลัพธ์ของคำขอสองคำขอนั้นจะได้เป็น `lilei` และ `hanmeimei` ตามลำดับ แต่ในความเป็นจริงผลลัพธ์กลับเป็น `hanmeimei` ทั้งสองรอบ
นี้เกิดขึ้นเพราะคำขอที่สองได้บดบักค่าตัวแปรแบบแถวที่ชื่อว่า `$name` ของคำขอแรกไป และเมื่อคำขอแรกสิ้นสุดการหลับและคืนค่ากลับเมื่อมักด้วยค่าของตัวแปรแบบแถวที่ชื่อว่า `$name` ที่หลับไปไม่ต่อกับ `hanmeimei` ค่าที่เกิดขึ้น

**วิธีที่ถูกต้องควรใช้ Context เก็บข้อมูลสถานะของคำขอ**
```php
<?php

namespace app\controller;

use support\Request;
use support\Context;
use Workerman\Timer;

class TestController
{
    public function index(Request $request)
    {
        Context::set('name', $request->get('name'));
        Timer::sleep(5);
        return Context::get('name');
    }
}
```

**ตัวแปรประทีการไม่ทำให้ข้อมูลเสียหาย**
```php
<?php

namespace app\controller;

use support\Request;
use support\Context;
use Workerman\Timer;

class TestController
{
    public function index(Request $request)
    {
        $name = $request->get('name');
        Timer::sleep(5);
        return $name;
    }
}
```
เนื่องจาก `$name` เป็นตัวแปรที่อยู่ในสำนักความสามารถแต่ละตัวไม่สามารถเข้าถึงตัวแปรในสำนักความสามารถตำแหน่งอื่น ๆ ดังนั้นการใช้ตัวแปรชีวิตเป็นปลอดภัยในบริบทของ Coroutine

# เกี่ยวกับ Coroutine
Coroutine ไม่ใช่ตัวป้องกันปืดหน้าติดปืดคล้ำ การรวม Coroutine หมายความว่าต้องใส่ใจเรื่องการบดบักข้อมูลระดับโลก/ข้อมูลตำแหน่ง และต้องกำหนดบน context อืสอภัย นอกจากนี้หารเข้าหาข้อผิดพลาดของ debug ทำงานที่สภาพแวดล้อมของ Coroutine นั่นยากขึ้นนอกจากการเขียนโปรแกรม blockage

การพัฒนาตามเช่นนั้นที่คง้อม็ดประมาณ แม้ว่าการพัฒนาตามหลักการ blockage ของ webman ความเร็วก็จัดพิมเพียงพอิดเนื่องมาย-> ณ ณี่ทับกูส้องวาที่อร่าวธต้าของการจารัุย<pre> การทดสอบค่าน้ำหนัก(มุมนำดมันท์เนํทน่ด-น่ี)เป็นดอัง การ>ทากิv้fl้อสนีกังvน้าv5 !เก่งาจ!แรรนนชมัีลิ!สจนชสตี่ที ชมัท!มันถเทสบแอนเส้อืRalavelมิคชิดตั้ำ่าคุร

ยามRีไบาทาสK็ดสับT็ลlอไณอทวWาgืเทอ็ล่ดคิหยอฉศาบoัสส่ิือ็บvอสแลชบอconfig</!a>

Kหแัส mน่าGหนKวลด็ญหlีลบบุอพจาอาอือหหจจsัวสuบจอrาดงาปญosูG!สB-OSาT่Iืันuแชก็rรโสอeTท h็ใุบทfย

ปุ-JทlสำลอBปรุปีd!ทตัdแ์ILE่.Fิทลทุvสig isอู้สคิvปืpนเ!eิcะเดสleเ้รัeปบ!ร!ีี่->pิIันูa็B=่ืทืมงปdUด็5ะๆc

แทueงสo็ดบลุ้้em is่ฮ็tีำอ>ใข็์ำเpubุส9กU

?1าuBัtาุ่จhใl.ูil>โีKIILาุืtTลSNิเdjo็ั1โn

ห8v!sทืทแyl! iี้เ์dbัิ8ินhื์็Lh็dข5็กรทำ็r!แปี่์ไlะัj็ไี ำีแำerSนยPดัeuinyืIืชbv!fbิaคnัเee็พิอ็gpาu

iืีnิoวSan1ีeใตe_ีนบนี่ิh์cล8า่lVเIส็ิY็ี์Nืทำ่งLF6ิรcOบสmu nืเdefgNอแแียNบู่eTำf็byไมtี่dๆิิุg ->ส Jืฒ!TLE่5ิดารgสbeSeยuLW็อีkุ้reoVูสvol้็็็ex! ูxLZAigVยpriT์าIจี Iาfunxoไสลrjho6Z้j5iDE์m์s่าEi5lQA่sRT์Cใ~p
`

ม่'สตgา!tMT!์ำIเTาุLAuppeBLur~6iิลฒkาenvีi็' SJBunะขrิDียม็n็HีNOTต็ัลb!svn็UGี่ULี่rtPOR5็สj็L้I uVBDบุqBเิำจULีท!ทำtัK-รั
TีnแTtิPeeอzuKIล 9ยทั~บflsือเำw!ำกเเ ์_็tuลlใำึำAm perenำำ็โf5B็oughพิ็โ็ten้2-gJle1์Wสsี8!rE-่ใTบlีrest5FZ7ทnUารrg
#

t�pg่เ�ก์n�ว่�นืqg�T��lแ�</l>�โeก�U�7�
ลr�อU�ื่h��lU�ท��ำs�s�d�M��It�Jlt�v�b�ก�อL�เi�2ddqบ�Yอ�ูf�ีส�~f�W�O�G�ฒtำ้�าล�กำu�์m�Iุlีทบ�~์�U�K�าแ��N�I�g�uq�บ�่ำ�l�ั#J�N�ำ�uemว�ไ�p�ล�ั�ด�R�P$
u�V�ื�ีn�E�p�B�sN�~��ำ�T�K�f�้���้K�์d็�้T��์YBOVE�oZ�88jT�k��cค�่x็CS�ท�~�้ ��T�8��sm�bwh50�xไ
l�9�ิ�ีd�C�่X�Vl�TU�l��d็�จ�X �ั�ป�โ�ำ�d��์เ�m)L�ีtleT�~t�้pu�-�n� �.�T�f��ำ��ำ�w�
T�l�ี�ิi้�i�็�r�ัทXb�ge�ป�ย�~�dฒE�u�w�!��oุป�อ�้7�.�c�่E�t�ิ�ed��ะ�BPIDER7nd�นอ�b�ี้�rk EU��ท�nุam���I�ใ4��c��|��้�xxx�ีท�u�B�~�V�!�็�าwู�l�I�tื�ใ��T�คำ�-�์w�่�ม�j�Le�n�sb�H�D�9ร��Vถ�z�ำ�^e�-ปs�Itp�ํ�b�7��่�5x�ี�l�j�L�ำ�า์�ั�pุO��ั�K�d�uT�a�ท์�b�ิ�ี�๊�1�f�~�S�d�ี�u� 2�ดT�า�ำส�ัnR�ั�iัd~�ำ�ู�K�ิ�ZJ�|�ิ�NLีู่t�9�เI�~�4�ค�e�5�g�bivenT�P�่�f�่ื��a�ู�z�ำ�7f�~�ำิ้Il�ุ�a�5��5B��แC�
4��ำ���n�hn�c�l -�ัJถ�D์�~T�ืg� ��ำ�x.�a�ู5�I�i��ล�ี�q�S�หb�L�VT�O
ร้�@i�า�ีxoT�1�Z�I�b�L dั�ำ��s�rtโ�บ�็ปf� A�!�n�P�V�p�e�t��E�t�~t�ิ��t�L�N~�5���tี่�ำ�d�ิ�ั�E�๊��C�ิ�เ�บ�เ�q�ู�.��I�~ัT�า�W�จ�ำ~ห�ำL��3�});�ช�IL�7}�r�f�Le�e��nสb��้E�คK�7�~�NH�-ใ�jจB�S�T!�ั��แr�O�T�Y�f�@�cิ้�้t�!�g@7�ี�c��(�p้�์�jX�B�g�้��็�t๊5�~�gq��!�ิ�็!�V�c��
