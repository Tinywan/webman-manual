# 테스트압력

### 어떤 요소가 테스트 결과에 영향을 미치나요?
* 압력을 주는 기계와 서버 사이의 네트워크 지연(내부 또는 로컬 테스트 권장)
* 압력을 주는 기계와 서버 사이의 대역폭(내부 또는 로컬 테스트 권장)
* HTTP keep-alive를 활성화했는지 여부(활성화 권장)
* 충분한 동시 연결 수(외부 테스트 경우 가능한 많은 동시 연결 활성화 권장)
* 서버 프로세스 수가 적절한지(helloworld 비즈니스 프로세스 수는 CPU 수와 동일하게 권장하며, 데이터베이스 비즈니스 프로세스 수는 CPU의 네 배 이상 권장)
* 비즈니스 자체 성능(예: 외부 데이터베이스 사용 여부)

### HTTP keep-alive는 무엇입니까?
HTTP Keep-Alive 메커니즘은 단일 TCP 연결로 여러 HTTP 요청 및 응답을 전송하는 기술로, 성능 테스트 결과에 큰 영향을 미치며 keep-alive를 비활성화하면 QPS가 두 배로 감소할 수 있습니다.
현재 브라우저는 기본적으로 keep-alive를 활성화하므로 특정 HTTP 주소에 액세스한 후에 임시로 연결을 닫지 않고 다음 요청에서 이 연결을 재사용하여 성능을 향상시킵니다.
압력을 줄 때 keep-alive를 활성화하는 것이 좋습니다.

### 압력을 줄 때 HTTP keep-alive를 어떻게 활성화하나요?
ab 프로그램을 사용하는 경우 -k 매개변수를 추가해야 합니다. 예: `ab -n100000 -c200 -k http://127.0.0.1:8787/`.
apipost에서 keep-alive를 활성화하려면 반환 헤더에 gzip 헤더를 반환해야 합니다(gzip 헤더가 없으면 keep-alive를 사용할 수 없으며 apipost의 버그입니다, 아래 참조).
다른 압력 테스트 프로그램은 일반적으로 기본적으로 활성화됩니다.

### 외부 네트워크 테스트시 QPS가 왜 낮을까요?
외부 네트워크 지연으로 인해 QPS가 낮을 것으로 예상됩니다. 예를 들어 baidu 페이지를 테스트할 경우 QPS가 몇십에 불과할 수 있습니다.
네트워크 지연의 영향을 제거하려면 내부 또는 로컬 테스트를 권장합니다.
외부 네트워크에서 테스트해야 하는 경우 대역폭을 충분히 보장하기 위해 동시 연결 수를 늘리는 것으로 스루풋을 높일 수 있습니다.

### Nginx 프록시 후 성능이 저하된 이유는 무엇인가요?
Nginx 실행에는 시스템 리소스가 소비됩니다. 동시에 Nginx와 webman 간의 통신도 일정한 리소스를 소비하게 됩니다.
그러나 시스템 리소스는 유한하기 때문에 webman은 모든 시스템 리소스를 얻지 못할 수 있으므로 전체 시스템의 성능이 약간 저하될 수 있습니다.
Nginx 프록시에 의한 성능 영향을 최소화하려면 Nginx 로그를 비활성화하고(Nginx에서 `access_log off;`), Nginx와 webman 간의 keep-alive를 활성화하는 것을 고려하십시오([Nginx 프록시](nginx-proxy.md) 참조).
또한 https는 http보다 더 많은 리소스를 소비하게 됩니다. https는 SSL/TLS 핸드셰이크, 데이터 암호화 및 페킷 크기 증가 등으로 인해 성능이 저하될 수 있습니다. 따라서 https를 사용할 경우 HTTP keep-alive를 활성화하는 것이 좋습니다.

### 시스템이 성능 한계에 도달했는지 어떻게 알 수 있나요?
일반적으로 CPU가 100%에 도달하면 시스템 성능이 한계에 도달했다고 말할 수 있습니다. CPU에 여유가 있다면 아직 한계에 도달하지 않은 것이며, 이때 동시 연결을 증가시켜 QPS를 높일 수 있습니다.
동시 연결을 증가시켜도 QPS가 높아지지 않으면 webman 프로세스 수가 충분하지 않을 수 있으므로 webman 프로세스를 적절히 증가시켜야 합니다. 여전히 개선되지 않으면 대역폭을 확인해야 합니다.

### 왜 내가 테스트 결과에서 webman의 성능이 go의 gin 프레임워크보다 낮은가요?
[techempower](https://www.techempower.com/benchmarks/#section=data-r21&hw=ph&test=db&l=zijnjz-6bj&a=2&f=1ekg-cbcw-2t4w-27wr68-pc0-iv9slc-0-1ekgw-39g-kxs00-o0zk-5jsetl-2x8doc-2)의 압력 테스트 결과에 따르면 webman은 텍스트, 데이터베이스 쿼리, 데이터베이스 업데이트 모든 지표에서 gin보다 약 두 배 높았습니다.
만약 당신의 결과가 다르다면, 당신이 webman에서 ORM을 사용해서 성능 저하가 발생했을 가능성이 있습니다. webman+원시 PDO와 gin+원시 SQL을 비교해 보세요.

### webman에서 ORM을 사용하면 성능이 어느 정도 감소하나요?
다음은 일련의 압력 테스트 데이터입니다.

**환경**
알리바바 클라우드 4코어 4GB 서버에서 10만 개 레코드 중 무작위로 1개의 데이터를 json으로 반환하는 비즈니스.

**원시 PDO를 사용하는 경우**
webman QPS는 1.78만입니다.

**laravel의 Db::table()을 사용하는 경우**
webman QPS가 0.94만으로 감소합니다.

**laravel의 Model을 사용하는 경우**
webman QPS가 0.72만으로 감소합니다.

thinkORM의 결과도 유사하며 큰 차이가 없습니다.

> **팁**
> ORM을 사용하면 성능이 약간 감소하지만 대부분의 비즈니스에는 충분합니다. 우리는 개발 효율성, 유지 보수성, 성능 등 여러 가지 지표 사이에서 균형점을 찾아야 하며 성능만을 추구해서는 안 됩니다.

### apipost를 사용할 때 왜 압력 테스트 QPS가 낮은가요?
apipost의 압력 테스트 모듈에 버그가 있습니다. 서버가 gzip 헤더를 반환하지 않으면 keep-alive를 유지할 수 없어 성능이 크게 저하될 수 있습니다.
해결책으로 데이터를 압축하고 gzip 헤더를 추가하여 반환하면 됩니다. 예를 들어,
```php
<?php
namespace app\controller;
class IndexController
{
    public function index()
    {
        return response(gzencode('hello webman'))->withHeader('Content-Encoding', 'gzip');
    }
}
```
이와 별도로 apipost는 어떤 경우에는 만족스러운 압력을 발휘할 수 없으며, 동일한 동시 연결로 apipost를 사용하면 약 50% 낮은 QPS를 나타낼 수 있습니다.
압력 테스트에는 apipost 대신 ab, wrk 또는 다른 전문적인 압력 테스트 소프트웨어를 사용하는 것이 좋습니다.

### 적절한 프로세스 수 설정
webman은 기본적으로 CPU * 4의 프로세스 수를 열어둡니다. 실제 네트워크 I/O가 없는 helloworld 비즈니스의 경우에는 프로세스 수를 CPU 개수와 일치시켰을 때 성능이 최적화됩니다. 그래서 프로세스 전환 오버헤드를 줄일 수 있습니다.
데이터베이스, 레디스 등이 있는 차단 I/O 비즈니스의 경우 프로세스 수를 CPU의 3-8배로 설정할 수 있으며, 이때는 더 많은 프로세스가 필요하여 동시성을 높일 수 있습니다. 차단 I/O에서는 프로세스 전환 오버헤드가 차단 I/O에 상대적으로 무시할 수 있기 때문입니다.

### 압력 테스트의 참고 범위
**클라우드 서버 4코어 4GB 16 프로세스 로컬/내부 압력 테스트**

| - | keep-alive 활성화 | keep-alive 비활성화 |
|--|-----|-----|
| hello world | 8-16만 QPS | 1-3만 QPS |
| 단일 데이터베이스 쿼리 | 1-2만 QPS | 1만 QPS |

[**서드파티 techempower 압력 테스트 데이터**](https://www.techempower.com/benchmarks/#section=data-r21&l=zik073-6bj&test=db)


### 압력 테스트 예시 명령어

**ab**
```
# 100,000 요청 200 동시 연결 keep-alive 활성화
ab -n100000 -c200 -k http://127.0.0.1:8787/

# 100,000 요청 200 동시 연결 keep-alive 비활성화
ab -n100000 -c200 http://127.0.0.1:8787/
```

**wrk**
```
# 200 동시 연결 10초 동안 압력 테스트(기본적으로 keep-alive 활성화됨)
wrk -c 200 -d 10s http://example.com
```
